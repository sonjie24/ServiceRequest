<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Master List</title>
    <link rel="stylesheet" href="/style/main.css" />
  </head>
  <body>
    <h1>Service Request</h1>

    <div class="top-bar">
      <input
        height="20px"
        type="text"
        id="searchInput"
        placeholder="Search by project name..."
      />
    </div>

    <div class="top-bar-left">
      <button id="createBtn">+ Create New Request</button>
    </div>

    <table id="masterTable">
      <thead>
        <tr>
          <th onclick="sortTable(0)" width="160px">Request No ‚¨ç</th>
          <th width="120px">Requested Date</th>
          <th width="250px">Module</th>
          <th width="300px">Form</th>
          <th width="500px">Concern</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="masterTableBody">
        <!-- Rows will be inserted here -->
      </tbody>
    </table>

    <!-- Modal -->
    <div id="createModal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div id="modalBody">Loading...</div>
      </div>
    </div>

    <script src="/js/config.js"></script>
    <script src="/js/session.js"></script>

    <script>
      async function loadMasterList() {
        try {
          const user = getUserSession();

          const projectName = user.project;
          const response = await fetch(`${API_BASE_URL}/get-all`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ projectName }),
          });
          const json = await response.json();
          const records = json.data;

          const tableBody = document.getElementById("masterTableBody");
          tableBody.innerHTML = "";

          if (!records || records.length === 0) {
            tableBody.innerHTML =
              "<tr><td colspan='6'>No data available</td></tr>";
            return;
          }

          records.forEach((record) => {
            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${record.service_request_no || "-"}</td>
            <td>${record.date_requested || "-"}</td>
            <td>${record.module || "-"}</td>
            <td>${record.system_form_name || "-"}</td>
            <td>${record.system_form_name || "-"}</td>
            <td class="action-buttons">
              <button onclick="viewRecord('${
                record.service_request_no
              }')">View</button>
              <button onclick="editRecord('${
                record.service_request_no
              }')">Edit</button>
              <button onclick="cancelRecord('${
                record.service_request_no
              }')">Cancel</button>
            </td>
          `;
            tableBody.appendChild(row);
          });
        } catch (error) {
          console.error("‚ùå Failed to load master list:", error);
        }
      }

      function setupSearch() {
        const searchInput = document.getElementById("searchInput");
        searchInput.addEventListener("input", function () {
          const filter = this.value.toLowerCase();
          const rows = document.querySelectorAll("#masterTableBody tr");

          rows.forEach((row) => {
            const cells = Array.from(row.cells);
            const matches = cells.some((cell) =>
              cell.textContent.toLowerCase().includes(filter)
            );
            row.style.display = matches ? "" : "none";
          });
        });
      }

      function viewRecord(id) {
        alert("View record: " + id);
      }

      function editRecord(id) {
        alert("Edit record: " + id);
      }

      function cancelRecord(id) {
        const confirmed = confirm(
          "Are you sure you want to cancel request " + id + "?"
        );
        if (confirmed) {
          alert("Request canceled: " + id);
          // Add actual cancel logic here
        }
      }

      window.addEventListener("DOMContentLoaded", () => {
        loadMasterList();
        setupSearch();
      });

      document
        .getElementById("createBtn")
        .addEventListener("click", function () {
          openModal();
        });

      function openModal() {
        const modal = document.getElementById("createModal");
        const modalBody = document.getElementById("modalBody");
        modal.style.display = "block";
        modalBody.innerHTML = "Loading...";

        fetch("entry.html")
          .then((res) => res.text())
          .then((html) => {
            modalBody.innerHTML = html;

            // Dynamically load the script
            const script = document.createElement("script");
            script.src = "/js/entry.js";
            script.defer = true;

            script.onload = () => {
              // üî• Call after JS is fully loaded
              if (typeof getDefaults === "function") {
                getDefaults();
              } else {
                console.warn("getDefaults is not defined");
              }
            };

            modalBody.appendChild(script);
          })

          .catch((err) => {
            modalBody.innerHTML = "<p>‚ö†Ô∏è Failed to load the entry form.</p>";
            console.error(err);
          });
      }

      function closeModal() {
        document.getElementById("createModal").style.display = "none";
      }

      // Do NOT close modal when clicking outside
      window.addEventListener("click", function (event) {
        const modal = document.getElementById("createModal");
        const modalContent = document.querySelector(".modal-content");

        // Check if clicked outside modalContent, but do nothing
        if (event.target === modal) {
          // Do nothing (don't close)
          event.stopPropagation();
        }
      });

      document.addEventListener("keydown", function (event) {
        const modal = document.getElementById("createModal");
        if (event.key === "Escape" && modal.style.display === "block") {
          event.preventDefault(); // Prevent ESC from closing
        }
      });
    </script>
  </body>
</html>
